<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AR Med - Pulm√£o 3D com Chat Integrado</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Chat overlay para AR */
    .ar-chat-overlay {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(51, 65, 85, 0.7);
      border-radius: 12px;
      z-index: 1000;
      max-height: 40vh;
      transition: all 0.3s ease;
    }

    .ar-chat-collapsed {
      height: 60px;
    }

    .ar-chat-expanded {
      height: 40vh;
    }

    .chat-messages-ar {
      max-height: calc(40vh - 120px);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #334155 rgba(0,0,0,0.3);
    }

    .chat-messages-ar::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages-ar::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
    }

    .chat-messages-ar::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 3px;
    }

    /* Bot√£o flutuante para chat em AR */
    .ar-chat-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(16, 185, 129, 0.9);
      backdrop-filter: blur(8px);
      border: 2px solid rgba(5, 150, 105, 0.7);
      color: white;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      animation: pulse 2s infinite;
    }

    .ar-chat-toggle:hover {
      background: rgba(5, 150, 105, 0.9);
      transform: scale(1.1);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
      50% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); }
    }

    /* Indicador de atividade do chat */
    .chat-activity {
      position: absolute;
      top: -5px;
      right: -5px;
      width: 20px;
      height: 20px;
      background: #ef4444;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }

    /* Layout adapt√°vel */
    .desktop-layout {
      display: flex;
      height: 100vh;
    }

    .ar-layout {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    #canvas-container {
      width: 100%;
      height: 100%;
      background: transparent;
    }

    /* Ocultar chat lateral em AR */
    .ar-mode .desktop-chat {
      display: none;
    }

    .ar-mode .ar-chat-overlay {
      display: block;
    }

    .desktop-mode .ar-chat-overlay {
      display: none;
    }

    /* Melhor contraste para AR */
    .ar-text {
      color: #ffffff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }

    .ar-button {
      background: rgba(30, 41, 59, 0.9) !important;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(51, 65, 85, 0.7) !important;
      color: #ffffff !important;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
    }

    .ar-button:hover {
      background: rgba(51, 65, 85, 0.9) !important;
    }
  </style>
  <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
      }
    }
  </script>
</head>
<body class="bg-slate-900 text-slate-100 overflow-hidden">
  
  <!-- Layout Desktop/AR Adapt√°vel -->
  <div id="app" class="desktop-layout desktop-mode">
    
    <!-- √Årea 3D -->
    <main class="flex-1 relative">
      <div id="canvas-container"></div>

      <!-- Barra superior -->
      <div class="absolute top-4 left-4 right-4 flex items-center gap-2">
        <div class="px-3 py-2 rounded bg-slate-800/70 backdrop-blur border border-slate-700 text-sm ar-text">
          <span class="font-semibold">AR Med</span> ‚Ä¢ Visualiza√ß√£o 3D/AR do pulm√£o
        </div>
        <div class="ml-auto flex gap-2">
          <button id="resetCameraBtn" class="px-3 py-2 rounded ar-button text-sm">Resetar C√¢mera</button>
          <button id="toggleAxesBtn" class="px-3 py-2 rounded ar-button text-sm">Eixos</button>
          <button id="mouseModeBtn" class="px-3 py-2 rounded ar-button text-sm">Modo Mouse</button>
          <div id="arButtonContainer"></div>
        </div>
      </div>

      <!-- Instru√ß√µes AR -->
      <div id="arInstructions" class="absolute bottom-4 left-4 right-4 px-4 py-3 rounded bg-slate-800/90 backdrop-blur border border-slate-700 text-sm text-center hidden ar-text">
        <p>üéÆ <strong>Controles AR:</strong></p>
        <p>‚Ä¢ Gatilho principal: Agarrar modelo ‚Ä¢ Gatilho lateral: Teleporte ‚Ä¢ Chat: Bot√£o verde no canto</p>
      </div>
    </main>

    <!-- Chat Desktop (lateral) -->
    <aside class="desktop-chat w-[380px] max-w-[90vw] border-l border-slate-800 bg-slate-900/90 backdrop-blur p-4 flex flex-col gap-3">
      <div>
        <h1 class="text-lg font-semibold">Assistente Pulmonar</h1>
        <p class="text-xs text-slate-300">Especializado em pulm√£o e patologias.</p>
      </div>

      <div id="chatMessagesDesktop" class="flex-1 overflow-auto space-y-3 pr-1 chat-messages-ar"></div>

      <form id="chatFormDesktop" class="flex gap-2">
        <input id="chatInputDesktop" type="text" placeholder="Pergunte sobre pulm√£o..." 
               class="flex-1 px-3 py-2 rounded bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-emerald-500" />
        <button id="recordBtnDesktop" type="button" class="px-3 py-2 rounded bg-red-600 hover:bg-red-500 text-white">
          üé§ Falar
        </button>
        <button id="sendBtnDesktop" type="submit" class="px-3 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white">Enviar</button>
      </form>
    </aside>
  </div>

  <!-- Chat AR Overlay -->
  <div id="arChatOverlay" class="ar-chat-overlay ar-chat-collapsed">
    <!-- Bot√£o Toggle do Chat -->
    <div class="flex items-center justify-between p-4 border-b border-slate-700/50">
      <h3 class="text-sm font-semibold text-white">Assistente Pulmonar</h3>
      <button id="toggleChatBtn" class="text-emerald-400 hover:text-emerald-300 transition-colors">
        <span id="toggleIcon">‚ñ≤</span>
      </button>
    </div>

    <!-- √Årea de mensagens (oculta quando colapsado) -->
    <div id="arChatContent" class="hidden">
      <div id="chatMessagesAR" class="chat-messages-ar p-4 space-y-3"></div>
      
      <div class="p-4 border-t border-slate-700/50">
        <form id="chatFormAR" class="flex gap-2">
          <input id="chatInputAR" type="text" placeholder="Pergunte sobre o pulm√£o..." 
                 class="flex-1 px-3 py-2 rounded bg-slate-800/70 border border-slate-600/50 focus:outline-none focus:ring-2 focus:ring-emerald-500 text-white placeholder-slate-400" />
          <button id="recordBtnAR" type="button" class="px-3 py-2 rounded bg-red-600/80 hover:bg-red-500 text-white backdrop-blur">
            üé§
          </button>
          <button id="sendBtnAR" type="submit" class="px-3 py-2 rounded bg-emerald-600/80 hover:bg-emerald-500 text-white backdrop-blur">
            üì§
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Bot√£o flutuante para ativar chat em AR -->
  <button id="arChatToggle" class="ar-chat-toggle" style="display: none;">
    üí¨
    <div id="chatNotification" class="chat-activity">!</div>
  </button>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { ARButton } from 'three/addons/webxr/ARButton.js';

    // Vari√°veis globais
    let renderer, scene, camera, controls, group;
    let isARMode = false;
    let lungModel = null;

    // Sistema de chat
    class ARChatSystem {
      constructor() {
        this.isExpanded = false;
        this.messageCount = 0;
        this.setupEventListeners();
        this.initializeChat();
      }

      setupEventListeners() {
        // Toggle chat AR
        document.getElementById('toggleChatBtn').addEventListener('click', () => {
          this.toggleChat();
        });

        // Bot√£o flutuante
        document.getElementById('arChatToggle').addEventListener('click', () => {
          this.showChat();
        });

        // Forms de chat
        document.getElementById('chatFormAR').addEventListener('submit', (e) => {
          e.preventDefault();
          this.sendMessage('AR');
        });

        document.getElementById('chatFormDesktop').addEventListener('submit', (e) => {
          e.preventDefault();
          this.sendMessage('Desktop');
        });

        // Bot√µes de voz
        document.getElementById('recordBtnAR').addEventListener('click', () => {
          this.startVoiceRecording('AR');
        });

        document.getElementById('recordBtnDesktop').addEventListener('click', () => {
          this.startVoiceRecording('Desktop');
        });
      }

      initializeChat() {
        const welcomeMsg = "Ol√°! Sou seu assistente especializado em pulm√£o e patologias respirat√≥rias. Como posso ajudar?";
        this.addMessage(welcomeMsg, false, 'both');
      }

      toggleChat() {
        const overlay = document.getElementById('arChatOverlay');
        const content = document.getElementById('arChatContent');
        const icon = document.getElementById('toggleIcon');

        this.isExpanded = !this.isExpanded;

        if (this.isExpanded) {
          overlay.classList.remove('ar-chat-collapsed');
          overlay.classList.add('ar-chat-expanded');
          content.classList.remove('hidden');
          icon.textContent = '‚ñº';
        } else {
          overlay.classList.remove('ar-chat-expanded');
          overlay.classList.add('ar-chat-collapsed');
          content.classList.add('hidden');
          icon.textContent = '‚ñ≤';
        }
      }

      showChat() {
        const overlay = document.getElementById('arChatOverlay');
        const toggle = document.getElementById('arChatToggle');
        
        if (!this.isExpanded) {
          this.toggleChat();
        }
        
        toggle.style.display = 'none';
        this.clearNotification();
      }

      async sendMessage(mode) {
        const inputId = mode === 'AR' ? 'chatInputAR' : 'chatInputDesktop';
        const sendBtnId = mode === 'AR' ? 'sendBtnAR' : 'sendBtnDesktop';
        
        const input = document.getElementById(inputId);
        const sendBtn = document.getElementById(sendBtnId);
        const text = input.value.trim();

        if (!text) return;

        // Adicionar mensagem do usu√°rio
        this.addMessage(text, true, 'both');
        input.value = '';
        sendBtn.disabled = true;

        // Mostrar indicador de digita√ß√£o
        const thinkingId = this.addMessage('ü§î Pensando...', false, 'both');

        try {
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              messages: [{ role: 'user', content: text }]
            })
          });

          const data = await response.json();
          this.removeMessage(thinkingId);
          
          if (data.answer) {
            this.addMessage(data.answer, false, 'both');
            // TTS para AR se dispon√≠vel
            if (isARMode) {
              this.playTTS(data.answer);
            }
          } else {
            this.addMessage('Desculpe, ocorreu um erro. Tente novamente.', false, 'both');
          }
        } catch (error) {
          console.error('Erro no chat:', error);
          this.removeMessage(thinkingId);
          this.addMessage('Erro de conex√£o. Verifique sua internet.', false, 'both');
        } finally {
          sendBtn.disabled = false;
        }
      }

      addMessage(text, isUser, target) {
        const messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const messageHTML = `
          <div id="${messageId}" class="flex ${isUser ? 'justify-end' : 'justify-start'} mb-2">
            <div class="max-w-[85%] rounded-lg ${isUser ? 'bg-emerald-700 text-white' : 'bg-slate-800 text-slate-100'} px-3 py-2 text-sm">
              ${this.escapeHtml(text)}
            </div>
          </div>
        `;

        if (target === 'both' || target === 'AR') {
          const arContainer = document.getElementById('chatMessagesAR');
          arContainer.insertAdjacentHTML('beforeend', messageHTML.replace(messageId, messageId + '_ar'));
          arContainer.scrollTop = arContainer.scrollHeight;
        }

        if (target === 'both' || target === 'Desktop') {
          const desktopContainer = document.getElementById('chatMessagesDesktop');
          desktopContainer.insertAdjacentHTML('beforeend', messageHTML.replace(messageId, messageId + '_desktop'));
          desktopContainer.scrollTop = desktopContainer.scrollHeight;
        }

        // Notifica√ß√£o em AR se chat estiver fechado
        if (isARMode && !isUser && !this.isExpanded) {
          this.showNotification();
        }

        return messageId;
      }

      removeMessage(messageId) {
        document.getElementById(messageId + '_ar')?.remove();
        document.getElementById(messageId + '_desktop')?.remove();
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      showNotification() {
        const notification = document.getElementById('chatNotification');
        const toggle = document.getElementById('arChatToggle');
        
        notification.style.display = 'flex';
        toggle.style.display = 'flex';
        this.messageCount++;
        
        if (this.messageCount > 9) {
          notification.textContent = '9+';
        } else {
          notification.textContent = this.messageCount;
        }
      }

      clearNotification() {
        const notification = document.getElementById('chatNotification');
        notification.style.display = 'none';
        this.messageCount = 0;
      }

      async startVoiceRecording(mode) {
        // Implementa√ß√£o b√°sica de grava√ß√£o de voz
        const recordBtn = document.getElementById(mode === 'AR' ? 'recordBtnAR' : 'recordBtnDesktop');
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const mediaRecorder = new MediaRecorder(stream);
          const chunks = [];

          mediaRecorder.ondataavailable = (e) => {
            if (e.data.size > 0) chunks.push(e.data);
          };

          mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/webm' });
            await this.processVoiceInput(blob, mode);
            stream.getTracks().forEach(track => track.stop());
          };

          recordBtn.textContent = mode === 'AR' ? '‚èπÔ∏è' : '‚èπÔ∏è Parar';
          recordBtn.style.background = '#dc2626';
          
          mediaRecorder.start();

          setTimeout(() => {
            if (mediaRecorder.state === 'recording') {
              mediaRecorder.stop();
              recordBtn.textContent = mode === 'AR' ? 'üé§' : 'üé§ Falar';
              recordBtn.style.background = '';
            }
          }, 5000); // Auto-stop after 5 seconds

        } catch (error) {
          console.error('Erro ao acessar microfone:', error);
          this.addMessage('Erro ao acessar o microfone. Verifique as permiss√µes.', false, 'both');
        }
      }

      async processVoiceInput(blob, mode) {
        const thinkingId = this.addMessage('üéôÔ∏è Transcrevendo √°udio...', true, 'both');

        try {
          const formData = new FormData();
          formData.append('file', blob, 'recording.webm');

          const response = await fetch('/api/voice/chat', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          this.removeMessage(thinkingId);

          if (data.transcript) {
            this.addMessage(data.transcript, true, 'both');
          }

          if (data.reply) {
            this.addMessage(data.reply, false, 'both');
          }

          if (data.audio_base64 && isARMode) {
            this.playAudioFromBase64(data.audio_base64);
          }

        } catch (error) {
          console.error('Erro no processamento de voz:', error);
          this.removeMessage(thinkingId);
          this.addMessage('Erro ao processar √°udio. Tente novamente.', false, 'both');
        }
      }

      async playTTS(text) {
        try {
          const response = await fetch('/api/voice/tts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text })
          });

          if (response.ok) {
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const audio = new Audio(url);
            await audio.play();
          }
        } catch (error) {
          console.warn('Erro no TTS:', error);
        }
      }

      playAudioFromBase64(base64) {
        try {
          const bytes = atob(base64);
          const arrayBuffer = new ArrayBuffer(bytes.length);
          const uint8Array = new Uint8Array(arrayBuffer);
          
          for (let i = 0; i < bytes.length; i++) {
            uint8Array[i] = bytes.charCodeAt(i);
          }

          const blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });
          const url = URL.createObjectURL(blob);
          const audio = new Audio(url);
          audio.play();
        } catch (error) {
          console.warn('Erro ao reproduzir √°udio:', error);
        }
      }
    }

    // Inicializa√ß√£o da cena 3D
    function init() {
      const container = document.getElementById('canvas-container');
      
      // Renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.xr.enabled = true;
      renderer.setClearColor(0x000000, 0);
      container.appendChild(renderer.domElement);

      // Cena
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1e293b);

      // C√¢mera
      camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(0, 1.6, 3);

      // Grupo para o modelo
      group = new THREE.Group();
      scene.add(group);

      // Luzes
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 0.5);
      scene.add(directionalLight);

      // Controles desktop
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // Carregar modelo do pulm√£o
      const loader = new GLTFLoader();
      loader.load('/models/lung.glb', (gltf) => {
        lungModel = gltf.scene;
        
        // Centralizar e escalar
        const box = new THREE.Box3().setFromObject(lungModel);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());
        
        lungModel.position.sub(center);
        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 2 / maxDim;
        lungModel.scale.setScalar(scale);
        
        group.add(lungModel);
        console.log('Modelo do pulm√£o carregado');
      }, undefined, (error) => {
        console.error('Erro ao carregar modelo:', error);
        
        // Fallback: criar um placeholder
        const geometry = new THREE.BoxGeometry(1, 1.5, 0.8);
        const material = new THREE.MeshStandardMaterial({ color: 0xff6b6b });
        const placeholder = new THREE.Mesh(geometry, material);
        group.add(placeholder);
      });

      // Bot√£o AR
      const arButton = ARButton.createButton(renderer, {
        requiredFeatures: ['hit-test'],
        optionalFeatures: ['dom-overlay'],
        domOverlay: { root: document.body }
      });
      document.getElementById('arButtonContainer').appendChild(arButton);

      // Event listeners
      setupEventListeners();

      // Sistema de chat
      window.chatSystem = new ARChatSystem();
    }

    function setupEventListeners() {
      // AR Session events
      renderer.xr.addEventListener('sessionstart', () => {
        console.log('Sess√£o AR iniciada');
        isARMode = true;
        document.getElementById('app').classList.remove('desktop-mode');
        document.getElementById('app').classList.add('ar-mode');
        scene.background = null;
        controls.enabled = false;
        
        // Posicionar modelo na frente da c√¢mera
        setTimeout(() => {
          group.position.set(0, 0, -2);
          group.visible = true;
        }, 1000);

        // Mostrar instru√ß√µes
        document.getElementById('arInstructions').classList.remove('hidden');
        setTimeout(() => {
          document.getElementById('arInstructions').classList.add('hidden');
        }, 8000);
      });

      renderer.xr.addEventListener('sessionend', () => {
        console.log('Sess√£o AR finalizada');
        isARMode = false;
        document.getElementById('app').classList.remove('ar-mode');
        document.getElementById('app').classList.add('desktop-mode');
        scene.background = new THREE.Color(0x1e293b);
        controls.enabled = true;
        document.getElementById('arChatToggle').style.display = 'none';
      });

      // Bot√µes de controle
      document.getElementById('resetCameraBtn').addEventListener('click', () => {
        if (isARMode) {
          group.position.set(0, 0, -2);
          group.rotation.set(0, 0, 0);
          group.scale.set(1, 1, 1);
        } else {
          camera.position.set(0, 1.6, 3);
          controls.target.set(0, 0, 0);
          controls.update();
        }
      });

      document.getElementById('toggleAxesBtn').addEventListener('click', () => {
        const axes = scene.getObjectByName('axes');
        if (axes) {
          axes.visible = !axes.visible;
        } else {
          const axesHelper = new THREE.AxesHelper(1);
          axesHelper.name = 'axes';
          group.add(axesHelper);
        }
      });

      document.getElementById('mouseModeBtn').addEventListener('click', () => {
        if (isARMode) {
          renderer.xr.getSession()?.end();
        }
      });

      // Resize
      window.addEventListener('resize', () => {
        const container = document.getElementById('canvas-container');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
      });
    }

    function animate() {
      renderer.setAnimationLoop(render);
    }

    function render() {
      if (controls.enabled) {
        controls.update();
      }

      // Anima√ß√£o suave do modelo quando n√£o est√° sendo manipulado
      if (lungModel && !isARMode) {
        lungModel.rotation.y += 0.005;
      }

      renderer.render(scene, camera);
    }

    // Inicializa√ß√£o
    init();
    animate();

  </script>
</body>
</html>